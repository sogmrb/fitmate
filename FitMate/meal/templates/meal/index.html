{% extends 'core/meals.html' %}

{% block main_content %}
    <head>
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
                crossorigin="anonymous"></script>

        <script>
            $(function () {
                $("#datepicker").datepicker({
                    onSelect: function (dateText) {
                        let selectedDate = $.datepicker.formatDate('yy-mm-dd', new Date(dateText));
                        $("#selected_date").val(selectedDate);
                        $("#date_form").submit();
                    }
                });
            });
        </script>
        <title>Meals</title>

    </head>

    <!-- Search Food Modal -->
    <div class="modal fade" id="searchFoodModal" tabindex="-1" aria-labelledby="searchFoodModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-custom">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchFoodModalLabel">Search Food</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modalContent">
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-grow" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <!-- Content will be loaded via AJAX -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Food Modal -->
    <div class="modal fade" id="addFoodModal" tabindex="-1" aria-labelledby="addFoodModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-custom modal-custom">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFoodModalLabel">Add Food Entry</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Content will be loaded via AJAX -->
                </div>
            </div>
        </div>
    </div>



    <script>
        $(document).ready(function () {
            $('#searchFoodModal').on('show.bs.modal', function (event) {
                const modal = $(this);
                $.ajax({
                    url: "{% url 'meal:search' %}",
                    type: "GET",
                    data: {
                        date: "{{ date | date:"Y-m-d" }}"
                    },
                    success: function (data) {
                        modal.find('.modal-body').html(data);
                        $('#searchFoodForm').on('submit', function (event) {
                            event.preventDefault();
                            modal.find('#loadingSpinner').show();
                            const query = $('input[name="query"]').val();
                            const date = $('input[name="date"]').val();

                            $.ajax({
                                url: "{% url 'meal:search' %}",
                                type: "GET",
                                data: {
                                    query: query,
                                    date: date
                                },
                                success: function (response) {
                                    $('.search-results-section, .no-results').remove();
                                    if (response.success) {
                                        modal.find('#loadingSpinner').hide();
                                        const results = response.results;
                                        const resultsContainer = $('<div class="search-results-section"></div>');
                                        resultsContainer.empty();
                                        if (results.length !== 0) {
                                            results.forEach(function (item) {
                                                const resultItem = `
                                                <div class="search-result-item">
                                                    <a href="#" class="open-add-modal" data-food-id="${item.id}" data-date="${date}">
                                                        ${item.name}
                                                    </a>
                                                </div>
                                            `;
                                                resultsContainer.append(resultItem);
                                            });
                                            $('.search-results-section').remove();
                                            $('#searchFoodForm').after(resultsContainer);

                                            $('.open-add-modal').on('click', function (e) {
                                                e.preventDefault();
                                                const foodId = $(this).data('food-id');
                                                const date = $(this).data('date');

                                                openAddFoodModal(foodId, date);
                                            });
                                        } else {
                                            modal.find('#loadingSpinner').hide();
                                            $('.search-results-section').remove();
                                            $('#searchFoodForm').after('<div class="no-results">No results found.</div>');
                                        }
                                    }
                                },
                                error: function (xhr, status, error) {
                                    alert("An error occurred. Please try again.");
                                }
                            });
                        });

                        function openAddFoodModal(foodId, date) {
                            const addFoodModal = $('#addFoodModal');
                            modal.find('#addFoodLoadingSpinner').show();
                            $.ajax({
                                url: "{% url 'meal:add' 0 %}".replace('0', foodId),
                                type: "GET",
                                data: {
                                    'date': date
                                },
                                success: function (response) {
                                    $('#searchFoodModal').modal('hide');
                                    modal.find('#addFoodLoadingSpinner').hide();
                                    addFoodModal.find('.modal-body').html(response);
                                    addFoodModal.modal('show');

                                    $('#addFoodForm').on('submit', function (event) {
                                        event.preventDefault();
                                        let formData = $(this).serializeArray();
                                        formData.push({name: 'date', value: date});
                                        $.ajax({
                                            url: "{% url 'meal:add' 0 %}".replace('0', foodId),
                                            type: "POST",
                                            data: $.param(formData),

                                            success: function (response) {
                                                if (response.success) {
                                                    addFoodModal.modal('hide');
                                                    location.reload();
                                                } else {
                                                    addFoodModal.find('.modal-body').html(response.html);
                                                }
                                            },
                                            error: function (xhr, status, error) {
                                                alert("An error occurred while submitting the form. Please try again.");
                                            }
                                        });
                                    })
                                },
                                error: function (xhr, status, error) {
                                    alert("An error occurred. Please try again.");
                                }
                            })
                        }
                    }
                });
            });
        });
    </script>



    <div class="add-food-date-section">
        <button type="button" class="add-food-button" style="border:none;" data-toggle="modal"
                data-target="#searchFoodModal"
                data-date="{{ date | date:'Y-m-d' }}">
            &#43; Add Food
        </button>


        <div class="date-navigation-box">
            <div class="navigate-date">
                {% if isToday %}
                    <a href="?date={{ prev_date }}" class="nav-button">&lt</a>
                    <span>Today</span>
                    <a href="?date={{ next_date }}" class="nav-button">&gt</a>
                {% else %}
                    <a href="?date={{ prev_date }}" class="nav-button">&lt</a>
                    <span>{{ date }}</span>
                    <a href="?date={{ next_date }}" class="nav-button">&gt</a>
                {% endif %}
            </div>
            <div class="select-date">
                <form id="date_form" method="get" action="{% url 'meal:index' %}">
                    <p>Date: <input class="date-picker" type="text" id="datepicker"></p>
                    <input type="hidden" id="selected_date" name="date">
                </form>
            </div>

        </div>
    </div>
    <div>

    </div>


    <div class="title-and-get-plan">
        <div class="my-title">My Meals</div>

    </div>

    <div class="modal fade" id="nutritionsModal" tabindex="-1" aria-labelledby="nutritionsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-custom modal-custom">
                <div class="modal-header">
                    <h5 class="modal-title" id="nutritionsModalLabel">Nutritional Data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="entry-information-table">
                        <tbody>
                        <tr>
                            <th class="entry-information-name">Calories:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_calories }}cal</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Carbs:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_carbs }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Protein:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_proteins }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Fat:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_fats }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Saturated Fat:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_saturated_fat }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Polyunsaturated Fat:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_polyunsaturated_fat }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Monounsaturated Fat:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_monounsaturated_fat }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Cholesterol:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_cholesterol }}mg</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Sodium:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_sodium }}mg</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Potassium:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_potassium }}mg</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Fiber:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_fibers }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Sugar:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_sugar }}g</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Calcium:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_calcium }}mg</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Iron:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_iron }}mg</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Vitamin A:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_vitamin_a }}mcg</td>
                        </tr>
                        <tr>
                            <th class="entry-information-name">Vitamin C:</th>
                            <td class="entry-information-value">{{ daily_stats.total_daily_vitamin_c }}mcg</td>
                        </tr>
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>

    <div class="main-meal-section">

        <div class="meal-section">
            {% if message %}
                <div class="no-entries">
                    No entries for this day.
                </div>
            {% else %}
                <div class="meal-time">
                    Breakfast
                </div>
                {% for food in food_entries %}
                    {% if food.meal_time == 'breakfast' %}
                        <div class="food-item">
                            <div class="food-item-name-quantity">
                                <div class="food-item-name">
                                    <a href="{% url "meal:detail" food.pk %}"> {{ food.food_name }}</a>
                                </div>
                                <div class="food-item-calories">
                                    {{ food.quantity }} x {{ food.serving_description }}
                                    &#183; {{ food.total_calories }} cals
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="meal-time">
                    Lunch
                </div>
                {% for food in food_entries %}
                    {% if food.meal_time == 'lunch' %}
                        <div class="food-item">
                            <div class="food-item-name-quantity">
                                <div class="food-item-name">
                                    <a href="{% url "meal:detail" food.pk %}"> {{ food.food_name }}</a>
                                </div>
                                <div class="food-item-calories">
                                    {{ food.quantity }} x {{ food.serving_description }}
                                    &#183; {{ food.total_calories }} cals
                                </div>
                            </div>

                        </div>
                    {% endif %}
                {% endfor %}
                <div class="meal-time">
                    Dinner
                </div>
                {% for food in food_entries %}
                    {% if food.meal_time == 'dinner' %}
                        <div class="food-item">
                            <div class="food-item-name-quantity">
                                <div class="food-item-name">
                                    <a href="{% url "meal:detail" food.pk %}"> {{ food.food_name }}</a>
                                </div>
                                <div class="food-item-calories">
                                    {{ food.quantity }} x {{ food.serving_description }}
                                    &#183; {{ food.total_calories }} cals
                                </div>
                            </div>

                        </div>
                    {% endif %}
                {% endfor %}
                <div class="meal-time">
                    Snacks
                </div>
                {% for food in food_entries %}
                    {% if food.meal_time == 'snack' %}
                        <div class="food-item">
                            <div class="food-item-name-quantity">
                                <div class="food-item-name">
                                    <a href="{% url "meal:detail" food.pk %}"> {{ food.food_name }}</a>
                                </div>
                                <div class="food-item-calories">
                                    {{ food.quantity }} x {{ food.serving_description }}
                                    &#183; {{ food.total_calories }} cals
                                </div>
                            </div>

                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="stats-and-warning">
            <div class="stats-section">
                <div class="stat-box">
                    <span class="stat-title">calories</span>
                    {% if message %}
                        <span class="eaten-stat">
                            0
                        </span>
                    {% else %}
                        <span class="eaten-stat">
                            {{ daily_stats.total_daily_calories }}
                        </span>
                    {% endif %}
                    <span class="total-stat">
                        of
                    </span>
                    <span class="total-stat">
                        {{ total_calories }} cals
                    </span>
                </div>
                <div class="stat-box">
                    <span class="stat-title">carbs</span>
                    {% if message %}
                        <span class="eaten-stat">
                            0
                        </span>
                    {% else %}
                        <span class="eaten-stat">
                            {{ daily_stats.total_daily_carbs }}
                        </span>
                    {% endif %}
                    <span class="total-stat">
                        of
                    </span>
                    <span class="total-stat">
                        {{ carb_g }}g
                    </span>
                </div>
                <div class="stat-box">
                    <span class="stat-title">protein</span>
                    {% if message %}
                        <span class="eaten-stat">
                            0
                        </span>
                    {% else %}
                        <span class="eaten-stat">
                            {{ daily_stats.total_daily_proteins }}
                        </span>
                    {% endif %}
                    <span class="total-stat">
                        of
                    </span>
                    <span class="total-stat">
                        {{ protein_g }}g
                    </span>
                </div>
                <div class="stat-box">
                    <span class="stat-title">fat</span>
                    {% if message %}
                        <span class="eaten-stat">
                            0
                        </span>
                    {% else %}
                        <span class="eaten-stat">
                    {{ daily_stats.total_daily_fats }}
                </span>
                    {% endif %}
                    <span class="total-stat">
                of
            </span>
                    <span class="total-stat">
                {{ fat_g }}g
            </span>
                </div>

            </div>
            {% if daily_stats %}
                <a href="#" class="get-nutrition" data-toggle="modal" data-target="#nutritionsModal">View full nutritional data</a>
            {% endif %}

            <div class="warning-div">
                {% if warning %}
                    <div class="cal-warning">
                        It is recommended that you consume at least 1200 calories per day. Consult with a doctor before
                        consuming fewer calories.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>



{% endblock %}
